name: Build macOS App

on: [push]

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        # 移除缓存配置（避免因缺少requirements.txt报错）
        
    - name: Install Xcode tools
      run: |
        sudo xcode-select --install || true
        sudo xcodebuild -license accept
        
    - name: Install dependencies
      run: |
        # 设置环境变量
        export SDKROOT=$(xcrun --show-sdk-path)
        export CFLAGS="-I$SDKROOT/usr/include"
        
        # 直接安装所需依赖（不依赖requirements.txt）
        pip install pyinstaller flask requests jinja2 pywebview
        # 补充Mac原生依赖（解决闪退核心）
        pip install pyobjc-core==10.2 pyobjc-framework-Cocoa==10.2 pyobjc-framework-WebKit==10.2
        
    - name: Build application
      run: |
        pyinstaller macos_spec.spec
        
    - name: Create DMG
      run: |
        hdiutil create -volname "ClickFlare工具" \
          -srcfolder dist/ClickFlare工具.app \
          -ov -format UDZO \
          dist/ClickFlare工具.dmg
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: macOS-App
        path: dist/ClickFlare工具.dmg
